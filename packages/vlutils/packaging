#!/bin/bash
set -e

# Extract VictoriaLogs utilities
tar -xzf vlutils/vlutils-linux-amd64-v1.36.1.tar.gz

# Create bin directory
mkdir -p ${BOSH_INSTALL_TARGET}/bin

# Check what utilities are actually in the archive
echo "Contents of the archive:"
ls -la

# Install all VictoriaLogs utility binaries
# The archive should contain VictoriaLogs-specific utilities
for binary in *-prod; do
  if [ -f "$binary" ]; then
    # Remove -prod suffix when installing
    target_name=$(echo "$binary" | sed 's/-prod$//')
    echo "Installing $binary as $target_name"
    cp "$binary" "${BOSH_INSTALL_TARGET}/bin/${target_name}"
  fi
done

# Also check for binaries without -prod suffix
for binary in vl*; do
  if [ -f "$binary" ] && [ ! -f "${binary}-prod" ]; then
    echo "Installing $binary"
    cp "$binary" "${BOSH_INSTALL_TARGET}/bin/${binary}"
  fi
done

# Make binaries executable
chmod +x ${BOSH_INSTALL_TARGET}/bin/*

# List installed binaries
echo "Installed binaries:"
ls -la ${BOSH_INSTALL_TARGET}/bin/