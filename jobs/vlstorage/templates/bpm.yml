---
processes:
  - name: vlstorage
    executable: /var/vcap/packages/victoria-logs/bin/victoria-logs-prod
    args:
      # Core Configuration - VictoriaLogs storage mode (no -storageNode flag)
      - -storageDataPath=<%= p('vlstorage.storage_path') %>
      - -retentionPeriod=<%= p('vlstorage.retention_period') %>
      - -httpListenAddr=0.0.0.0:<%= p('vlstorage.http_port') %>

      # Future retention
      <% if p('vlstorage.future_retention') != "" %>
      - -futureRetention=<%= p('vlstorage.future_retention') %>
      <% end %>

      # Logging Configuration
      - -loggerLevel=<%= p('vlstorage.log_level') %>
      - -loggerFormat=<%= p('vlstorage.log_format') %>
      - -loggerOutput=<%= p('vlstorage.logger_output') %>
      - -loggerTimezone=<%= p('vlstorage.logger_timezone') %>
      - -loggerMaxArgLen=<%= p('vlstorage.logger_max_arg_len') %>
      <% if p('vlstorage.logger_disable_timestamps') %>
      - -loggerDisableTimestamps
      <% end %>
      <% if p('vlstorage.logger_json_fields') != "" %>
      - -loggerJSONFields=<%= p('vlstorage.logger_json_fields') %>
      <% end %>
      <% if p('vlstorage.logger_errors_per_second_limit') > 0 %>
      - -loggerErrorsPerSecondLimit=<%= p('vlstorage.logger_errors_per_second_limit') %>
      <% end %>
      <% if p('vlstorage.logger_warns_per_second_limit') > 0 %>
      - -loggerWarnsPerSecondLimit=<%= p('vlstorage.logger_warns_per_second_limit') %>
      <% end %>
      <% if p('vlstorage.log_ingested_rows') %>
      - -logIngestedRows
      <% end %>
      <% if p('vlstorage.log_new_streams') %>
      - -logNewStreams
      <% end %>

      # Memory Configuration
      - -memory.allowedPercent=<%= p('vlstorage.memory_allowed_percent') %>
      <% if p('vlstorage.memory_allowed_bytes') != "" %>
      - -memory.allowedBytes=<%= p('vlstorage.memory_allowed_bytes') %>
      <% end %>

      # Search Configuration
      <% if p('vlstorage.search_max_concurrent_requests') > 0 %>
      - -search.maxConcurrentRequests=<%= p('vlstorage.search_max_concurrent_requests') %>
      <% end %>
      - -search.maxQueueDuration=<%= p('vlstorage.search_max_queue_duration') %>
      - -search.maxQueryDuration=<%= p('vlstorage.search_max_query_duration') %>

      # Insert Configuration
      <% if p('vlstorage.max_concurrent_inserts') > 0 %>
      - -maxConcurrentInserts=<%= p('vlstorage.max_concurrent_inserts') %>
      <% end %>
      - -insert.maxQueueDuration=<%= p('vlstorage.insert_max_queue_duration') %>

      # Authentication
      <% if p('vlstorage.http_auth_username') != "" && p('vlstorage.http_auth_password') != "" %>
      - -httpAuth.username=<%= p('vlstorage.http_auth_username') %>
      - -httpAuth.password=<%= p('vlstorage.http_auth_password') %>
      <% end %>
      <% if p('vlstorage.flags_auth_key') != "" %>
      - -flagsAuthKey=<%= p('vlstorage.flags_auth_key') %>
      <% end %>
      <% if p('vlstorage.metrics_auth_key') != "" %>
      - -metricsAuthKey=<%= p('vlstorage.metrics_auth_key') %>
      <% end %>
      <% if p('vlstorage.pprof_auth_key') != "" %>
      - -pprofAuthKey=<%= p('vlstorage.pprof_auth_key') %>
      <% end %>
      <% if p('vlstorage.force_flush_auth_key') != "" %>
      - -forceFlushAuthKey=<%= p('vlstorage.force_flush_auth_key') %>
      <% end %>
      <% if p('vlstorage.force_merge_auth_key') != "" %>
      - -forceMergeAuthKey=<%= p('vlstorage.force_merge_auth_key') %>
      <% end %>

      # HTTP Server Configuration
      - -http.connTimeout=<%= p('vlstorage.http_conn_timeout') %>
      - -http.idleConnTimeout=<%= p('vlstorage.http_idle_conn_timeout') %>
      - -http.maxGracefulShutdownDuration=<%= p('vlstorage.http_max_graceful_shutdown_duration') %>
      <% if p('vlstorage.http_shutdown_delay') != "" %>
      - -http.shutdownDelay=<%= p('vlstorage.http_shutdown_delay') %>
      <% end %>
      <% if p('vlstorage.http_path_prefix') != "" %>
      - -http.pathPrefix=<%= p('vlstorage.http_path_prefix') %>
      <% end %>
      <% if p('vlstorage.http_disable_cors') %>
      - -http.disableCORS
      <% end %>
      <% if p('vlstorage.http_disable_keep_alive') %>
      - -http.disableKeepAlive
      <% end %>
      <% if p('vlstorage.http_disable_response_compression') %>
      - -http.disableResponseCompression
      <% end %>

      # HTTP Security Headers
      <% if p('vlstorage.http_header_csp') != "" %>
      - -http.header.csp=<%= p('vlstorage.http_header_csp') %>
      <% end %>
      <% if p('vlstorage.http_header_frame_options') != "" %>
      - -http.header.frameOptions=<%= p('vlstorage.http_header_frame_options') %>
      <% end %>
      <% if p('vlstorage.http_header_hsts') != "" %>
      - -http.header.hsts=<%= p('vlstorage.http_header_hsts') %>
      <% end %>

      # Cache Configuration
      - -blockcache.missesBeforeCaching=<%= p('vlstorage.blockcache_misses_before_caching') %>

      # Disk Space Management
      - -storage.minFreeDiskSpaceBytes=<%= p('vlstorage.storage_min_free_disk_space_bytes') %>
      - -inmemoryDataFlushInterval=<%= p('vlstorage.inmemory_data_flush_interval') %>

      # Network Configuration
      <% if p('vlstorage.enable_tcp6') %>
      - -enableTCP6
      <% end %>

      # TLS Configuration
      <% p('vlstorage.tls').each_with_index do |enabled, i| %>
        <% if enabled %>
      - -tls
        <% end %>
      <% end %>
      <% p('vlstorage.tls_cert_file').each do |cert| %>
      - -tlsCertFile=<%= cert %>
      <% end %>
      <% p('vlstorage.tls_key_file').each do |key| %>
      - -tlsKeyFile=<%= key %>
      <% end %>
      <% p('vlstorage.tls_cipher_suites').each do |suite| %>
      - -tlsCipherSuites=<%= suite %>
      <% end %>
      <% p('vlstorage.tls_min_version').each do |version| %>
      - -tlsMinVersion=<%= version %>
      <% end %>
      <% p('vlstorage.mtls').each_with_index do |enabled, i| %>
        <% if enabled %>
      - -mtls
        <% end %>
      <% end %>
      <% p('vlstorage.mtls_ca_file').each do |ca| %>
      - -mtlsCAFile=<%= ca %>
      <% end %>

      # TLS Autocert Configuration
      <% p('vlstorage.tls_autocert_hosts').each do |host| %>
      - -tlsAutocertHosts=<%= host %>
      <% end %>
      <% if p('vlstorage.tls_autocert_email') != "" %>
      - -tlsAutocertEmail=<%= p('vlstorage.tls_autocert_email') %>
      <% end %>
      <% if p('vlstorage.tls_autocert_cache_dir') != "" %>
      - -tlsAutocertCacheDir=<%= p('vlstorage.tls_autocert_cache_dir') %>
      <% end %>

      # Push Metrics Configuration
      <% p('vlstorage.pushmetrics_url').each do |url| %>
      - -pushmetrics.url=<%= url %>
      <% end %>
      <% if !p('vlstorage.pushmetrics_url').empty? %>
      - -pushmetrics.interval=<%= p('vlstorage.pushmetrics_interval') %>
      <% end %>
      <% p('vlstorage.pushmetrics_extra_label').each do |label| %>
      - -pushmetrics.extraLabel=<%= label %>
      <% end %>
      <% p('vlstorage.pushmetrics_header').each do |header| %>
      - -pushmetrics.header=<%= header %>
      <% end %>
      <% if p('vlstorage.pushmetrics_disable_compression') %>
      - -pushmetrics.disableCompression
      <% end %>

      # Metrics Metadata
      <% if p('vlstorage.metrics_expose_metadata') %>
      - -metrics.exposeMetadata
      <% end %>

      # Misc Configuration
      - -internStringMaxLen=<%= p('vlstorage.intern_string_max_len') %>
      - -internStringCacheExpireDuration=<%= p('vlstorage.intern_string_cache_expire_duration') %>
      <% if p('vlstorage.intern_string_disable_cache') %>
      - -internStringDisableCache
      <% end %>
      <% if p('vlstorage.envflag_enable') %>
      - -envflag.enable
      <% end %>
      <% if p('vlstorage.envflag_prefix') != "" %>
      - -envflag.prefix=<%= p('vlstorage.envflag_prefix') %>
      <% end %>
      <% if p('vlstorage.filestream_disable_fadvise') %>
      - -filestream.disableFadvise
      <% end %>
      <% if p('vlstorage.fs_disable_mmap') %>
      - -fs.disableMmap
      <% end %>
      <% p('vlstorage.http_listen_addr_use_proxy_protocol').each_with_index do |enabled, i| %>
        <% if enabled %>
      - -httpListenAddr.useProxyProtocol
        <% end %>
      <% end %>

      # License Configuration
      <% if p('vlstorage.license') != "" %>
      - -license=<%= p('vlstorage.license') %>
      <% end %>
      <% if p('vlstorage.license_file') != "" %>
      - -licenseFile=<%= p('vlstorage.license_file') %>
      <% end %>
      <% if p('vlstorage.license_force_offline') %>
      - -license.forceOffline
      <% end %>

    persistent_disk: true
    ephemeral_disk: false

    limits:
      open_files: 65536

    env:
      GOGC: "100"
      GOMAXPROCS: "4"