#!/bin/bash
set -e

HTTP_PORT=<%= p('vlstorage.http_port') %>

echo "[$(date '+%H:%M:%S')] vmstorage: Starting post-start health check..."

# Wait for vmstorage to be ready
max_wait=60
elapsed=0

while [ $elapsed -lt $max_wait ]; do
    if curl -sf "http://localhost:${HTTP_PORT}/health" >/dev/null 2>&1; then
        echo "[$(date '+%H:%M:%S')] vmstorage health check passed"

        # Also check metrics endpoint
        if curl -sf "http://localhost:${HTTP_PORT}/metrics" >/dev/null 2>&1; then
            echo "[$(date '+%H:%M:%S')] vmstorage metrics endpoint ready"
            exit 0
        fi
    fi
    sleep 1
    elapsed=$((elapsed + 1))
done

echo "[$(date '+%H:%M:%S')] ERROR: vmstorage health check failed after ${max_wait}s"
exit 1
