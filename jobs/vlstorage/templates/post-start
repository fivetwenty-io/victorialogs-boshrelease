#!/bin/bash
set -e

PORT=<%= p('vlstorage.port') %>
READY_DIR=/var/vcap/sys/run/ready
READY_FILE=$READY_DIR/vlstorage

set_ready() {
    local service=$1
    touch $READY_DIR/$service
    echo "[$(date '+%H:%M:%S')] $service: Ready"
}

echo "[$(date '+%H:%M:%S')] VLStorage: Starting post-start health check..."

# Wait for VLStorage to be ready
max_wait=60
elapsed=0

while [ $elapsed -lt $max_wait ]; do
    if curl -sf "http://localhost:${PORT}/health" >/dev/null 2>&1; then
        echo "[$(date '+%H:%M:%S')] VLStorage health check passed"
        set_ready "vlstorage"
        exit 0
    fi
    sleep 1
    elapsed=$((elapsed + 1))
done

echo "[$(date '+%H:%M:%S')] ERROR: VLStorage health check failed after ${max_wait}s"
exit 1
