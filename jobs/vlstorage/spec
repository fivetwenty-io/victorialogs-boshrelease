---
name: vlstorage
packages:
- victoria-logs

templates:
  bpm.yml: config/bpm.yml
  pre-start: bin/pre-start
  post-deploy: bin/post-deploy
  post-start: bin/post-start
  vlstorage: bin/vlstorage
  vlstorage-health-check: bin/vlstorage-health-check

provides:
- name: vlstorage
  type: vlstorage
  properties:
  - vlstorage.http_port

properties:
  # Network Configuration
  vlstorage.http_port:
    description: "Port for VictoriaLogs storage HTTP API"
    default: 9491
  vlstorage.enable_tcp6:
    description: "Whether to enable IPv6 for listening and dialing"
    default: false

  # Storage Configuration
  vlstorage.storage_path:
    description: "Path to VictoriaLogs storage data"
    default: "/var/vcap/store/vlstorage/data"
  vlstorage.retention_period:
    description: "Log entries retention period (e.g., 7d, 1w, 1y)"
    default: "7d"
  vlstorage.future_retention:
    description: "Future retention for logs (e.g., 2d)"
    default: "2d"
  vlstorage.storage_min_free_disk_space_bytes:
    description: "The minimum free disk space at storage path"
    default: "10000000"
  vlstorage.inmemory_data_flush_interval:
    description: "The interval for guaranteed saving of in-memory data to disk"
    default: "5s"

  # Performance Configuration
  vlstorage.max_concurrent_inserts:
    description: "The maximum number of concurrent insert requests"
    default: 32
  vlstorage.insert_max_queue_duration:
    description: "Maximum duration to wait in queue for insert requests"
    default: "1m"

  # Search Configuration
  vlstorage.search_max_concurrent_requests:
    description: "Maximum concurrent search requests"
    default: 100
  vlstorage.search_max_queue_duration:
    description: "Maximum time to wait in queue for search requests"
    default: "10s"
  vlstorage.search_max_query_duration:
    description: "Maximum duration for query execution"
    default: "30s"

  # Memory Configuration
  vlstorage.memory_allowed_percent:
    description: "Allowed percent of system memory VictoriaLogs caches may occupy"
    default: 60
  vlstorage.memory_allowed_bytes:
    description: "Allowed size of system memory VictoriaLogs caches may occupy"
    default: ""

  # Cache Configuration
  vlstorage.blockcache_misses_before_caching:
    description: "The number of cache misses before putting the block into cache"
    default: 2

  # HTTP Server Configuration
  vlstorage.http_conn_timeout:
    description: "Timeout for incoming HTTP connections"
    default: "2m"
  vlstorage.http_idle_conn_timeout:
    description: "Timeout for incoming idle HTTP connections"
    default: "1m"
  vlstorage.http_max_graceful_shutdown_duration:
    description: "Maximum duration for graceful shutdown"
    default: "7s"
  vlstorage.http_shutdown_delay:
    description: "Optional delay before HTTP server shutdown"
    default: ""
  vlstorage.http_path_prefix:
    description: "Optional prefix for HTTP paths"
    default: ""
  vlstorage.http_disable_cors:
    description: "Disable CORS for all origins"
    default: false
  vlstorage.http_disable_keep_alive:
    description: "Disable HTTP keep-alive"
    default: false
  vlstorage.http_disable_response_compression:
    description: "Disable compression of HTTP responses"
    default: false

  # HTTP Security Headers
  vlstorage.http_header_csp:
    description: "Content-Security-Policy header value"
    default: ""
  vlstorage.http_header_frame_options:
    description: "X-Frame-Options header value"
    default: ""
  vlstorage.http_header_hsts:
    description: "Strict-Transport-Security header value"
    default: ""

  # Authentication
  vlstorage.http_auth_username:
    description: "Username for HTTP Basic Auth"
    default: ""
  vlstorage.http_auth_password:
    description: "Password for HTTP Basic Auth"
    default: ""
  vlstorage.flags_auth_key:
    description: "Auth key for /flags endpoint"
    default: ""
  vlstorage.metrics_auth_key:
    description: "Auth key for /metrics endpoint"
    default: ""
  vlstorage.pprof_auth_key:
    description: "Auth key for /debug/pprof endpoints"
    default: ""
  vlstorage.force_flush_auth_key:
    description: "Auth key for /internal/force_flush endpoint"
    default: ""
  vlstorage.force_merge_auth_key:
    description: "Auth key for /internal/force_merge endpoint"
    default: ""

  # TLS Configuration
  vlstorage.tls:
    description: "Enable TLS for incoming HTTP requests"
    default: []
  vlstorage.tls_cert_file:
    description: "Path to TLS certificate file"
    default: []
  vlstorage.tls_key_file:
    description: "Path to TLS key file"
    default: []
  vlstorage.tls_cipher_suites:
    description: "TLS cipher suites"
    default: []
  vlstorage.tls_min_version:
    description: "Minimum TLS version"
    default: []
  vlstorage.mtls:
    description: "Require valid client certificate"
    default: []
  vlstorage.mtls_ca_file:
    description: "Path to TLS Root CA for client verification"
    default: []

  # Logging Configuration
  vlstorage.log_level:
    description: "Minimum level of errors to log (INFO, WARN, ERROR, FATAL, PANIC)"
    default: "INFO"
  vlstorage.log_format:
    description: "Format for logs (default, json)"
    default: "default"
  vlstorage.logger_output:
    description: "Output for logs (stderr, stdout)"
    default: "stderr"
  vlstorage.logger_timezone:
    description: "Timezone for log timestamps"
    default: "UTC"
  vlstorage.logger_disable_timestamps:
    description: "Disable timestamps in logs"
    default: false
  vlstorage.logger_json_fields:
    description: "Rename fields in JSON formatted logs"
    default: ""
  vlstorage.logger_errors_per_second_limit:
    description: "Per-second limit on ERROR messages"
    default: 0
  vlstorage.logger_warns_per_second_limit:
    description: "Per-second limit on WARN messages"
    default: 0
  vlstorage.logger_max_arg_len:
    description: "Maximum length of logged argument"
    default: 5000
  vlstorage.log_ingested_rows:
    description: "Log all ingested log entries"
    default: false
  vlstorage.log_new_streams:
    description: "Log creation of new streams"
    default: false

  # Push Metrics Configuration
  vlstorage.pushmetrics_url:
    description: "URLs to push metrics to"
    default: []
  vlstorage.pushmetrics_interval:
    description: "Interval for pushing metrics"
    default: "10s"
  vlstorage.pushmetrics_extra_label:
    description: "Extra labels for pushed metrics"
    default: []
  vlstorage.pushmetrics_header:
    description: "HTTP headers for push requests"
    default: []
  vlstorage.pushmetrics_disable_compression:
    description: "Disable compression for push requests"
    default: false

  # Metrics Exposure
  vlstorage.metrics_expose_metadata:
    description: "Expose TYPE and HELP metadata at /metrics"
    default: false

  # Misc Configuration
  vlstorage.intern_string_max_len:
    description: "Maximum length for string interning"
    default: 500
  vlstorage.intern_string_cache_expire_duration:
    description: "Expiry duration for interned string caches"
    default: "6m"
  vlstorage.intern_string_disable_cache:
    description: "Disable caches for interned strings"
    default: false
  vlstorage.envflag_enable:
    description: "Enable reading flags from environment variables"
    default: false
  vlstorage.envflag_prefix:
    description: "Prefix for environment variables"
    default: ""
  vlstorage.filestream_disable_fadvise:
    description: "Disable fadvise() syscall"
    default: false
  vlstorage.fs_disable_mmap:
    description: "Use pread() instead of mmap()"
    default: false
  vlstorage.http_listen_addr_use_proxy_protocol:
    description: "Use proxy protocol for connections"
    default: []

  # License Configuration
  vlstorage.license:
    description: "License key for VictoriaMetrics Enterprise"
    default: ""
  vlstorage.license_file:
    description: "Path to license file"
    default: ""
  vlstorage.license_file_reload_interval:
    description: "Interval for reloading license file"
    default: "1h"
  vlstorage.license_force_offline:
    description: "Enable offline license verification"
    default: false

  # TLS Autocert Configuration
  vlstorage.tls_autocert_hosts:
    description: "Hostnames for Let's Encrypt certificates"
    default: []
  vlstorage.tls_autocert_email:
    description: "Contact email for Let's Encrypt"
    default: ""
  vlstorage.tls_autocert_cache_dir:
    description: "Directory for Let's Encrypt certificates"
    default: ""